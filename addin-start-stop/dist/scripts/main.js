"use strict";geotab.addin.startStop=function(){var d,i,o,r,l,c,s,u,n,p=2e3,D=.1,m=function(t){n=t,d.call("Get",{typeName:"Device",search:{groups:i.getGroupFilter(),fromDate:(new Date).toISOString()},resultsLimit:1e3},function(e){e=e.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}).map(function(e){return{name:e.name,id:e.id}});n===t&&n(e)},function(e){alert(e)})};function f(n,a,i){return new Promise(function(e,t){d.call("Get",{typeName:"Trip",search:{deviceSearch:{id:n},fromDate:a,toDate:i},resultsLimit:1e4},e,t)})}function g(e,t,n,a){n*=t/1e3/60;a=a||"",o=document.getElementById("stopStart-times"+a),r=document.getElementById("stopStart-idling"+a),l=document.getElementById("stopStart-fuel"+a),-1===e?(o.innerText="-",r.innerText="-:--",l.innerText="-"):(o.innerText=Math.round(e),r.innerText=function(e){var t=parseInt(e,10),e=Math.floor(t/3600),t=Math.floor((t-3600*e)/60);t<10&&(t="0"+t);return e+":"+t}(t/1e3),l.innerText=Math.round(n*c*100)/100)}function h(e,t,n){g(e,t,n,"-annual")}function S(){g(-1),h(-1),""!==this.value&&function(o){document.getElementById("stopStart-vehicleSelect").disabled=!0;var r=new Date,l=new Date;l.setDate(r.getDate()-1);var c=0,s=0,u=0;t(30,function(n){var t,a,i;t=o,a=l,i=r,new Promise(function(h,e){d.multiCall([["Get",{typeName:"StatusData",search:{deviceSearch:{id:t},fromDate:a.toISOString(),toDate:i.toISOString()},resultsLimit:5e4}],["Get",{typeName:"LogRecord",search:{deviceSearch:{id:t},fromDate:a,toDate:i},resultsLimit:5e4}]],function(e){var t,n,a,i=e[0],e=e[1],o=!1,r=!1,l=!1,c=null,s=null,u=null,d=0,m=0,f=[],g=i.filter(function(e){switch(e.diagnostic.id){case"DiagnosticVehicleActiveId":case"DiagnosticEngineSpeedId":case"DiagnosticTotalTripIdleFuelUsedId":return!0;default:return!1}});for((g=(g=g.concat(e)).map(function(e){return e.dateTime=new Date(e.dateTime),e})).sort(function(e,t){return e.dateTime-t.dateTime}),n=0;n<g.length;n++){if((t=g[n]).diagnostic)switch(t.diagnostic.id){case"DiagnosticVehicleActiveId":o=1===t.data;break;case"DiagnosticEngineSpeedId":r=0<t.data;break;case"DiagnosticTotalTripIdleFuelUsedId":m+=t.data}else l=0!==t.speed;null===(u=!l&&r&&null==u?t.dateTime:u)||!l&&r||(d+=t.dateTime-u,u=null),!o||r||a?!a||o&&!r||(s=t.dateTime,p<s-c&&f.push({fromDate:c,duration:s-c}),a=!1):(a=!0,c=t.dateTime)}h({fuelUsedPerMinuteIdling:0<d&&D<m?m/(d/1e3/60):0,stopStarts:f})},e)}).then(function(e){var t=e.stopStarts,e=e.fuelUsedPerMinuteIdling;0<(s+=t.length)&&(t.forEach(function(e){c+=e.duration}),g(s,c,u=0<e?0===u?e:(u+e)/2:u)),l.setDate(l.getDate()-1),r.setDate(r.getDate()-1),n.next()})},function(){l=new Date,r=new Date,l.setDate(l.getDate()-30),f(o,l,r).then(function(e){var n,a,i=0;e.forEach(function(e){i+=e.distance}),0<i?(h((n=s/i)*i,(a=c/i)*i,u),t(11,function(t){f(o,l,r).then(function(e){e.forEach(function(e){i+=e.distance}),h(n*i,a*i,u),l.setDate(l.getDate()-30),r.setDate(r.getDate()-30),t.next()})},function(){document.getElementById("stopStart-vehicleSelect").disabled=!1})):document.getElementById("stopStart-vehicleSelect").disabled=!1})})}(this.value)}function t(e,t,n){var a=0,i=!1,o={next:function(){i||(a<e?(a++,t(o)):(i=!0,n()))},iteration:function(){return a-1},break:function(){i=!0,n()}};return o.next(),o}return{initialize:function(e,t,n){d=e,i=t,u=document.getElementById("startStop"),i.translate&&i.translate(u||""),n()},focus:function(e,t){var n,a;d=e,i=t,g(-1),n=function(){var t;t=function(){document.getElementById("stopStart-volume-label").innerHTML=s,document.getElementById("stopStart-volume-label-annual").innerHTML=s,console.log("updateDashboardRegionalUnits"),u.style.display="block"},d.getSession(function(e){e=e.userName;d.call("Get",{typeName:"User",search:{name:e}},function(e){if(0===e.length)throw new Error("Unable to find currently logged on user.");e=e[0];switch(e.fuelEconomyUnit){case"LitersPer100Km":case"KmPerLiter":c=1,s=i.translate("Liters");break;case"MPGUS":c=1/3.785411784,s=i.translate("Gallons (US)");break;case"MPGImperial":c=1/4.54609,s=i.translate("Gallons (UK)");break;default:c=1,s=i.translate("Liters")}console.log(e.isMetric),console.log(e.fuelEconomyUnit),console.log(e.language),console.log(e.dateFormat),console.log(e.timeZoneId),t()},function(e){throw"Error while trying to load currently logged on user. "+e})})},(a=document.getElementById("stopStart-vehicleSelect")).innerHTML="",a.removeEventListener("change",S),a.appendChild(((t=document.createElement("option")).default=!0,t.selected=!0,t.value="",t.textContent=i.translate("Select a vehicle..."),t)),m(function(e){e.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.textContent=e.name,a.appendChild(t)}),a.addEventListener("change",S),n()})},blur:function(){u.style.display="none"}}};