"use strict";geotab.addin.heatmap=function(){function v(e){a.innerHTML=e}function m(e){i.innerHTML=e}var h,p,y,E,I,w,D,o,a,i,l,x,t,B=5e4;function b(e){if(!e||0===e.length)return 1;for(var t=0;t<e.length;t++)if(0<e[t].length)return;return 1}function S(e){return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}function N(){return Math.round((new Date-t)/1e3)}function T(e){e?(o.disabled=!0,l.style.display="block"):(setTimeout(function(){l.style.display="none"},600),o.disabled=!1)}function c(){void 0!==y&&p.removeLayer(y),y=L.heatLayer({radius:{value:24,absolute:!1},opacity:.7,gradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}}).addTo(p);for(var e=x=0;e<I.options.length;e++)I.options[e].selected&&x++;0!==x?(t=new Date,(!0===E.disabled?r:u)()):v("Please select at least one vehicle from the list and try again.")}function d(e){p=new L.Map("heatmap-map",{center:new L.LatLng(e.latitude,e.longitude),zoom:13}),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2VvdGFiIiwiYSI6ImNpd2NlaW02MjAxc28yeW9idTR3dmRxdTMifQ.ZH0koA2g2YMMBOcx6EYbwQ").addTo(p),E=document.getElementById("exceptionTypes"),I=document.getElementById("vehicles"),w=document.getElementById("from"),D=document.getElementById("to"),o=document.getElementById("showHeatMap"),a=document.getElementById("error"),i=document.getElementById("message"),l=document.getElementById("loading");var t=(n=new Date).getDate(),e=n.getMonth()+1,n=n.getFullYear();w.value=n+"-"+(e=e<10?"0"+e:e)+"-"+(t=t<10?"0"+t:t)+"T00:00",D.value=n+"-"+e+"-"+t+"T23:59",document.getElementById("visualizeByLocationHistory").addEventListener("click",function(e){E.disabled=!0}),document.getElementById("visualizeByExceptionHistory").addEventListener("click",function(e){E.disabled=!1}),document.getElementById("exceptionTypes").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("vehicles").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("from").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("to").addEventListener("change",function(e){e.preventDefault()}),document.getElementById("showHeatMap").addEventListener("click",function(e){e.preventDefault(),c()})}function n(e,t){return(e=e.name.toLowerCase())===(t=t.name.toLowerCase())?0:t<e?1:-1}var r=function(){I.value;for(var e,t=[],n=I.options,o=0,a=n.length;o<a;o++)(e=n[o]).selected&&t.push(e.value||e.text);var i=w.value,l=D.value;if(v(""),m(""),null!==t&&""!==i&&""!==l){T(!0);for(var c=new Date(i).toISOString(),d=new Date(l).toISOString(),r=[],u=0,s=t.length;u<s;u++)r.push(["Get",{typeName:"LogRecord",resultsLimit:B,search:{deviceSearch:{id:t[u]},fromDate:c,toDate:d}}]);h.multiCall(r,function(e){if(b(e))return v("No data to display"),void T(!1);for(var t=[],n=[],o=0,a=0,i=0,l=e.length;i<l;i++){for(var c=e[i],d=0;d<c.length;d++)0===c[d].latitude&&0===c[d].longitude||(t.push({lat:c[d].latitude,lon:c[d].longitude,value:1}),n.push(new L.LatLng(c[d].latitude,c[d].longitude)),o++);c.length>=B&&a++}0<t.length?(p.fitBounds(n),y.setLatLngs(t),m("Displaying ".concat(S(o)," combined log records for the\n        ").concat(S(x)," selected vehicles. [").concat(N()," sec]")),0<a&&v("Note: Not all results are displayed because the result limit of \n          ".concat(S(B)," was exceeded for \n          ").concat(S(a)," of the selected vehicles."))):v("No data to display"),T(!1)},function(e){alert(e),T(!1)})}},u=function(){I.value;for(var e,t=E.options[E.selectedIndex].value,g=E.options[E.selectedIndex].text,n=[],o=I.options,a=0,i=o.length;a<i;a++)(e=o[a]).selected&&n.push(e.value||e.text);var l=w.value,c=D.value;if(v(""),m(""),null!==n&&null!==t&&""!==l&&""!==c){T(!0);for(var d=new Date(l).toISOString(),r=new Date(c).toISOString(),u=[],s=0,f=n.length;s<f;s++)u.push(["Get",{typeName:"ExceptionEvent",resultsLimit:B,search:{deviceSearch:{id:n[s]},ruleSearch:{id:t},fromDate:d,toDate:r}}]);h.multiCall(u,function(e){if(b(e))return v("No data to display"),void T(!1);for(var u=0,s=0,t=[],n=0,o=e.length;n<o;n++){for(var a=e[n],i=0;i<a.length;i++)u++,t.push(["Get",{typeName:"LogRecord",resultsLimit:B,search:{deviceSearch:{id:a[i].device.id},fromDate:a[i].activeFrom,toDate:a[i].activeTo}}]);a.length>=B&&s++}h.multiCall(t,function(e){if(b(e))return v("No data to display"),void T(!1);for(var t,n=[],o=[],a=0,i=0,l=0,c=e.length;l<c;l++){for(var d=e[l],r=0;r<d.length;r++)0===d[r].latitude&&0===d[r].longitude||(n.push({lat:d[r].latitude,lon:d[r].longitude,value:1}),o.push(new L.LatLng(d[r].latitude,d[r].longitude)),a++);d.length>=B&&i++}0<n.length?(p.fitBounds(o),y.setLatLngs(n),m("Displaying ".concat(S(a)," combined log records associated with the\n          ").concat(S(u)," '").concat(g,"' rule exceptions found for the \n          ").concat(S(x)," selected vehicles. [").concat(N()," sec]")),(0<s||0<i)&&(t="Note: Not all results are displayed because",s&&(t+=" the result limit of \n              ".concat(S(B)," was exceeded for '").concat(g,"' rule exceptions")),0<s&&0<i&&(t+=" and"),0<i&&(t+=" the result limit of \n              ".concat(S(B)," was exceeded for \n              ").concat(S(exceededResultsLimitCount)," of the selected vehicles.")),v(t+=".")),T(!1)):v("No data to display")},function(e){alert(e),T(!1)})},function(e){alert(e),T(!1)})}};return{initialize:function(e,t,n){h=e,"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){d(e.coords),n()}):(d({longitude:-79.709441,latitude:43.434497}),n())},focus:function(e,t){(h=e).call("Get",{typeName:"Device",resultsLimit:5e4,search:{fromDate:(new Date).toISOString(),groups:t.getGroupFilter()}},function(e){!e||e.length<0||(e.sort(n),e.forEach(function(e){var t=new Option;t.text=e.name,t.value=e.id,I.add(t)}))},v),h.call("Get",{typeName:"Rule",resultsLimit:5e4},function(e){!e||e.length<0||(e.sort(n),e.forEach(function(e){var t=new Option;t.text=e.name,t.value=e.id,E.add(t)}))},v),setTimeout(function(){p.invalidateSize()},200)}}};