"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,c=e[Symbol.iterator]();!(r=(o=c.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==c.return||c.return()}finally{if(a)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,r,a,i,o){try{var c=e[i](o),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,a)}function _asyncToGenerator(c){return function(){var e=this,o=arguments;return new Promise(function(t,n){var r=c.apply(e,o);function a(e){asyncGeneratorStep(r,t,n,a,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,a,i,"throw",e)}a(void 0)})}}geotab.addin.proximity=function(){function y(e){C.innerHTML=e}function h(e){clearTimeout(t),e?(A.disabled=!0,R.style.display="block",_.textContent="Cancel",k.disabled=!0,f.disabled=!0,p.disabled=!0,I.disabled=!0,D.disabled=!0,S.disabled=!0,E.disabled=!0,G.hidden=!0):t=setTimeout(function(){R.style.display="none",_.textContent="Run",k.disabled=!1,f.disabled=!1,p.disabled=!1,I.disabled=!1,D.disabled=!1,S.disabled=!1,E.disabled=!1,G.hidden=!1},600)}function u(e){return e*(N?1:1.09361)}function g(e){var t=new L.LatLng(e.latitude,e.longitude),n=e.distance,t=(r=t,new L.Marker(r,{icon:new L.DivIcon({className:"map-icon",iconSize:[16,16]})})),r=new Date(e.dateTime);t.bindTooltip("".concat(B[e.device.id].name," was ").concat(Math.floor(u(n))," ").concat(N?" m":" yd"," away on ").concat(r.toDateString()," at ").concat(r.toTimeString())),d.addLayer(t)}function v(){d.clearLayers(),T.clearLayers()}function b(e){return[(e=e.split("T"))[0],e[1].split(".")[0]]}function s(){F=!1,j=["DeviceID, Date, Time, Latitude, Longitude\n"],v();var e=new Date(S.value+":00Z"),f=new Date(e.setMinutes(e.getMinutes()+(new Date).getTimezoneOffset())).toISOString(),e=new Date(E.value+":00Z"),p=new Date(e.setMinutes(e.getMinutes()+(new Date).getTimezoneOffset())).toISOString();h(!0);var n=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,u,r,a,i,o,c,s,l,d,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t||t.length<1||!t[0])return h(!1),y("Could not find the address"),e.abrupt("return");e.next=4;break;case 4:return n=function(e){return e.forEach(function(e){g(e);var t=_slicedToArray(b(e.dateTime),2),n=t[0],t=t[1];j.push("".concat(B[e.device.id].name,", ").concat(n,", ").concat(t,", ").concat(e.latitude,", ").concat(e.longitude,"\n"))}),e.length},u=function(e,t,n){return["Get",{typeName:"LogRecord",search:{deviceSearch:{id:e},fromDate:t,toDate:n},resultsLimit:5e4}]},r=(d=function(e,t,n,r,a){return new L.Circle([t,e],n,{stroke:!1,fillColor:r,fillOpacity:a})})(t[0].x,t[0].y,+O,"#ff4444",.3),a=d(t[0].x,t[0].y,2*O,"#ff8800",.3),m=d(t[0].x,t[0].y,3*O,"#ff8800",.3),l=d(t[0].x,t[0].y,4*O,"#99cc00",.3),d=d(t[0].x,t[0].y,5*O,"#33b5e5",.3),i={latitude:t[0].y,longitude:t[0].x},window.geotabHeatMap=window.geotabHeatMap||{},window.geotabHeatMap.center=i,x.setView(new L.LatLng(i.latitude,i.longitude),14),T.addLayer(r),T.addLayer(a),T.addLayer(m),T.addLayer(l),T.addLayer(d),m=P.map(function(e){return B[e]}),o=[],c=function(t){return new Promise(function(e){5e4===t.length&&o.push(z(device.name));var params={array:t,center:i,radiusFactor:O,aggregate:!0,maxThreads:navigator.hardwareConcurrency||1};hamsters.promise(params,function(){function r(e){return e*(Math.PI/180)}var a=params.center,i=5*params.radiusFactor;params.array.forEach(function(e){var t,n;e.id&&(t=r(a.latitude-e.latitude),n=r(a.longitude-e.longitude),n=Math.sin(t/2)*Math.sin(t/2)+Math.cos(r(e.latitude))*Math.cos(r(a.latitude))*Math.sin(n/2)*Math.sin(n/2),n=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),e.distance=6371e3*n,e.distance<i&&rtn.data.push(e))})}).then(function(rtn){return rtn.data[0]}).then(n).then(e)})},s=function(e){return new Promise(function(a,t){F?a():w.multiCall(e,function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=n=0;case 2:if(r<t.length)return e.t0=n,e.next=6,c(t[r]);e.next=10;break;case 6:n=e.t0+=e.sent;case 7:r++,e.next=2;break;case 10:a(n);case 11:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),function(e){h(!1),y(e),t(e)})})},l=function(c){return new Promise(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=[],r=[],i=a=0;i<c.length;i++)r.push(u(c[i].id,f,p)),400==r.length&&(n.push(r),r=[]);n.push(r),o=0;case 6:if(o<n.length)return e.t0=a,e.next=10,s(n[o]);e.next=14;break;case 10:a=e.t0+=e.sent;case 11:o++,e.next=6;break;case 14:t(a);case 15:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}())},d=0,e.next=25,l(m);case 25:m=e.sent,d=m,isNaN(m)&&(v(),d=-1),m=0===o.length?"":"<p>* ".concat(o.join(",")," was limited to ").concat(5e4," GPS positions, try narrowing date range to see all positions.</p>"),y((0<d?"<p>There were ".concat(d," locations recorded nearby to ").concat(k.value,". <br><br> Press Deselect All button to start new search.</p>"):0==d?"<p>There was no one near this area during this time frame. <br><br> Press Deselect All button to start new search.</p>":"<p>The operation was cancelled. <br><br> Press Deselect All button to start new search.</p>").concat(m)),A.disabled=!1,h(!1);case 32:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}();(e=function(e){e=e.split(",");return 2===e.length&&parseFloat(e[0])&&parseFloat(e[1])?[{x:parseFloat(e[1]),y:parseFloat(e[0])}]:[]}(k.value)).length?n(e):w.call("GetCoordinates",{addresses:[k.value]},function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n(t);case 1:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),function(e){y(e),h(!1)})}function a(r,e){function t(e){var t,n=u(5*e);O=e,n=r&&1e3<=n?(t=Number(Math.round(n/1e3+"e1")+"e-1"),"km"):!r&&1760<=n?(t=Number(Math.round(n/1760+"e1")+"e-1"),"mi"):(t=Math.round(n),r?" m":" yd"),document.getElementById("proximity-size-label").innerHTML="("+t+" "+n+")"}N=r,x=new L.Map("proximity-map",{center:new L.LatLng(e.latitude,e.longitude),zoom:9}),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2VvdGFiIiwiYSI6ImNpd2NlaW02MjAxc28yeW9idTR3dmRxdTMifQ.ZH0koA2g2YMMBOcx6EYbwQ").addTo(x),d=L.markerClusterGroup({spiderfyOnMaxZoom:!1,disableClusteringAtZoom:18}).addTo(x),T=L.layerGroup().addTo(x),k=document.getElementById("proximity-address"),f=document.getElementById("proximity-size"),p=document.getElementById("proximity-select-all"),I=document.getElementById("proximity-deselect-all"),D=document.getElementById("proximity-vehicles"),S=document.getElementById("proximity-from"),E=document.getElementById("proximity-to"),C=document.getElementById("proximity-error"),R=document.getElementById("proximity-loading"),M=document.getElementById("proximity-div-vehicles"),A=document.getElementById("proximity-run-report"),_=document.getElementById("proximity-run-cancel"),G=document.getElementById("proximity-userInput");var n,a,i,o=(c=new Date).getDate(),e=c.getMonth()+1,c=c.getFullYear();S.value=c+"-"+(e=e<10?"0"+e:e)+"-"+(o=o<10?"0"+o:o)+"T00:00",E.value=c+"-"+e+"-"+o+"T23:59",t(300),m=new Choices(D,{removeItemButton:!0,duplicateItemsAllowed:!1,searchResultLimit:1e3,maxItemCount:1e3,noChoicesText:"Start typing to search for vehicles"}),M.addEventListener("keyup",(n=function(e){m.clearChoices();var e="%"+e.target.value+"%",r=[];console.log("manualSearch: ",e),"%%"!=e&&w.call("Get",{typeName:"Device",search:{fromDate:(new Date).toISOString(),groups:l.getGroupFilter(),name:e},resultsLimit:1e3},function(e){if(e&&!(e.length<1)){for(var t=0;t<e.length;t++)P.includes(e[t].id)||r.push(e[t]);var n=r.map(function(e){return{value:(B[e.id]=e).id,label:z(e.name)}});m=m.setChoices(n,"value","label",!0),h(!1)}},function(e){y(e),h(!1)})},a=1e3,function(){var e=this,t=arguments;clearTimeout(i),i=setTimeout(function(){n.apply(e,t)},a)})),p.addEventListener("click",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(h(!0),y(""),0===Object.keys(B).length&&0===P.length)return e.next=5,new Promise(function(t){w.call("Get",{typeName:"Device",search:{fromDate:(new Date).toISOString(),groups:l.getGroupFilter()},resultsLimit:1e3},function(e){t(e)})});e.next=13;break;case 5:for(t=e.sent,n=[],r=0;r<t.length;r++)n.push(t[r]),P.push(t[r].id);a=n.map(function(e){return{value:(B[e.id]=e).id,label:z(e.name)}}),1e3===t.length?(y("1000 vehicle limit reached. The proximity add-in will show 1000 vehicles only."),m.disable()):m.setValue(a),console.log("Devices included: ",a),e.next=32;break;case 13:i=[],e.t0=regeneratorRuntime.keys(B);case 15:if((e.t1=e.t0()).done){e.next=31;break}if(o=e.t1.value,P.includes(o))return e.abrupt("continue",15);e.next=21;break;case 21:if(!(P.length<1e3)){e.next=26;break}P.push(o),i.push({value:o,label:B[o].name}),e.next=29;break;case 26:return y("1000 vehicle limit reached."),m.clearChoices(),e.abrupt("break",31);case 29:e.next=15;break;case 31:m.setValue(i);case 32:m.clearInput(),m.clearChoices(),h(!1);case 35:case"end":return e.stop()}},e)}))),I.addEventListener("click",function(){m.clearStore(),m.enable(),v(),y(""),P=[],B={}}),m.passedElement.element.addEventListener("change",function(){P=m.getValue().map(function(e){return e.value})}),_.addEventListener("click",function(){"Run"==_.innerText?function(){var e="",t=1;y(""),""===k.value&&(e+="Please input an address <br>",t=0);0===P.length&&(e+="Select at least one vehicle to display <br>",t=0);var n=new Date(S.value+":00Z"),r=new Date(E.value+":00Z");r<n&&(e+="From date cannot be more than To date <br>",t=0);return y(e),t}()&&s():(_.textContent="Canceling...",F=!0)}),A.addEventListener("click",function(){var e,t,n=_slicedToArray(b((new Date).toISOString()),2),r=n[0],a=n[1];j=j.size?j:new Blob(j),n=j,a="ProximityReport-".concat(r,"-").concat(a.replace(/\:/g,"."),".csv"),window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(n,a):(e=document.createElement("a"),t=URL.createObjectURL(n),e.href=t,e.download=a,document.body.appendChild(e),e.click(),setTimeout(function(){document.body.removeChild(e),window.URL.revokeObjectURL(t)},0))}),f.addEventListener("change",function(e){t(e.target.value)}),S.addEventListener("change",function(e){e.preventDefault()}),E.addEventListener("change",function(e){e.preventDefault()})}var w,l,x,d,T,m,k,f,p,I,D,M,S,E,C,R,A,_,G,t,O=250,B={},P=[],N=!0,F=!1,j=["DeviceID, Date, Time, Latitude, Longitude\n"],z=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")};return{initialize:function(e,t,r){w=e,l=t,hamsters.init&&hamsters.init({debug:"verbose"}),function(t){if(!t)throw new Error('"callback" is null or undefined');w.getSession(function(e){w.call("Get",{typeName:"User",search:{name:e.userName}},function(e){t(0<e.length&&!!e[0].isMetric)},function(){t(!1)})},!1)}(function(t){var n={longitude:-79.709441,latitude:43.434497};"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){a(t,e.coords),r()},function(e){a(t,n),r()},{timeout:5e3}):(a(t,n),r())})},focus:function(e,t){w=e,l=t,F=!0,h(!(B={}))},blur:function(){B=B&&{},F=!0}}};